---
- hosts: localhost
  tags:
    - classic
  tasks:
    - dnf:
        name: "*"
        state: latest

- hosts: localhost
  roles:
  - role: standard-test-basic
    tags:
    - classic
    repositories:
    - repo: "https://src.fedoraproject.org/tests/python.git"
      dest: "python"
    pybasever: "3.12"
    tests:
    - rpm_qa:
        run: rpm -qa
    - smoke:
        dir: python/smoke
        run: "VERSION={{ pybasever }} TOX=false ./venv.sh"
    - selftest:
        dir: python/selftest
        run: "VERSION={{ pybasever }} X='-i test_check_probes' ./parallel.sh"
    - debugtest:
        dir: python/selftest
        run: "VERSION={{ pybasever }} PYTHON=python{{ pybasever }}d X='-i test_check_probes' ./parallel.sh"
    - debugflags:
        dir: python/flags
        run: "python{{ pybasever }}d ./assertflags.py -O0"
    - pytest:
        dir: .
        run: PYTHONPATH=/usr/lib/rpm/redhat ALTERNATE_PYTHON_VERSION=skip pytest-3.12 -v
    - manual_byte_compilation_clamp_mtime_off:
        dir: .
        run: rpmbuild --define 'dist .clamp0' --define 'clamp_mtime_to_source_date_epoch 0' -ba pythontest.spec
    - manual_byte_compilation_clamp_mtime_on:
        dir: .
        run: rpmbuild --define 'dist .clamp1' --define 'clamp_mtime_to_source_date_epoch 1' -ba pythontest.spec
    - rpmlint_clamp_mtime_off:
        dir: .
        run: rpmlint ~/rpmbuild/RPMS/x86_64/pythontest-0-0.clamp0.x86_64.rpm | grep python-bytecode-inconsistent-mtime || exit 0 && exit 1
    - rpmlint_clamp_mtime_on:
        dir: .
        run: rpmlint ~/rpmbuild/RPMS/x86_64/pythontest-0-0.clamp1.x86_64.rpm | grep python-bytecode-inconsistent-mtime || exit 0 && exit 1
    required_packages:
    - gcc  # for extension building in venv and selftest
    - gcc-c++ # for test_cppext
    - gdb  # for test_gdb
    - "python{{ pybasever }}"  # the test subject
    - "python{{ pybasever }}-debug"  # for leak testing
    - "python{{ pybasever }}-devel"  # for extension building in venv and selftest
    - "python{{ pybasever }}-tkinter"  # for selftest
    - "python{{ pybasever }}-test"  # for selftest
    - glibc-all-langpacks # for locale tests
    - rpm  # for debugging
    - rpm-build
    - rpmlint
    - python-rpm-macros
    - python3-rpm-macros
    - python3.12-rpm-macros
    - python3.12-devel
    - python3.12-pytest
    - python3
    - python3-devel
    - python2

